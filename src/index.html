<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Catalog Builder</title>
    <link rel="stylesheet" href="ui/styles.css">
</head>
<body>
    <script>
        console.log('=== INDEX.HTML LOADED ===');
        console.log('Document ready state:', document.readyState);
        window.addEventListener('error', function(e) {
            console.error('GLOBAL ERROR:', e.error);
            console.error('Error message:', e.message);
            console.error('Error filename:', e.filename);
            console.error('Error line:', e.lineno);
        });
        window.addEventListener('unhandledrejection', function(e) {
            console.error('UNHANDLED PROMISE REJECTION:', e.reason);
        });
    </script>
    
    <div id="app" class="app-container">
        <!-- Header -->
        <div class="header">
            <h1 class="app-title">Catalog Builder</h1>
            <p class="app-subtitle">Professional Catalog Creation for InDesign</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-button active" data-tab="import">Import Data</button>
            <button class="tab-button" data-tab="mapping">Field Mapping</button>
            <button class="tab-button" data-tab="template">Template</button>
            <button class="tab-button" data-tab="advanced">Advanced</button>
            <button class="tab-button" data-tab="generate">Generate</button>
            <button class="tab-button" data-tab="settings">Settings</button>
        </div>

        <!-- Tab Contents -->
        <div class="tab-content">
            <!-- Import Tab -->
            <div id="import-tab" class="tab-pane active">
                <h2>Import Data Source</h2>
                
                <div class="form-group">
                    <label for="dataSourceType">Data Source Type:</label>
                    <select id="dataSourceType" class="select-input">
                        <option value="csv">CSV File</option>
                        <option value="excel">Excel File (.xlsx, .xls)</option>
                        <option value="json">JSON File</option>
                        <option value="xml">XML File</option>
                    </select>
                </div>

                <div class="form-group">
                    <button id="selectFileBtn" class="btn btn-primary">Select File</button>
                    <span id="selectedFile" class="file-name">No file selected</span>
                </div>

                <!-- CSV Options -->
                <div id="csvOptions" class="options-panel">
                    <h3>CSV Options</h3>
                    <div class="form-group">
                        <label for="csvDelimiter">Delimiter:</label>
                        <select id="csvDelimiter" class="select-input">
                            <option value=",">Comma (,)</option>
                            <option value=";">Semicolon (;)</option>
                            <option value="\t">Tab</option>
                            <option value="|">Pipe (|)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="csvEncoding">Encoding:</label>
                        <select id="csvEncoding" class="select-input">
                            <option value="utf-8">UTF-8</option>
                            <option value="utf-16">UTF-16</option>
                            <option value="iso-8859-1">ISO-8859-1</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="csvHeader" checked>
                            First row contains headers
                        </label>
                    </div>
                </div>

                <!-- Excel Options -->
                <div id="excelOptions" class="options-panel" style="display: none;">
                    <h3>Excel Options</h3>
                    <div class="form-group">
                        <label for="excelSheet">Sheet:</label>
                        <select id="excelSheet" class="select-input">
                            <option value="0">Sheet 1</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <button id="importBtn" class="btn btn-success" disabled>Import Data</button>
                </div>

                <!-- Data Preview -->
                <div id="dataPreview" class="preview-panel" style="display: none;">
                    <h3>Data Preview</h3>
                    <div class="preview-stats">
                        <span id="recordCount">Records: 0</span>
                        <span id="columnCount">Columns: 0</span>
                    </div>
                    <div id="previewTable" class="preview-table"></div>
                </div>
            </div>

            <!-- Mapping Tab -->
            <div id="mapping-tab" class="tab-pane">
                <h2>Field Mapping</h2>
                
                <div class="mapping-container">
                    <div class="source-fields">
                        <h3>Data Fields</h3>
                        <div id="sourceFieldsList" class="field-list">
                            <p class="empty-message">Import data first</p>
                        </div>
                    </div>

                    <div class="mapping-arrow">→</div>

                    <div class="target-frames">
                        <h3>InDesign Frames</h3>
                        <button id="detectFramesBtn" class="btn btn-secondary">Detect Frames</button>
                        <div id="targetFramesList" class="field-list">
                            <p class="empty-message">Select a frame in InDesign</p>
                        </div>
                    </div>
                </div>

                <div class="mapping-actions">
                    <button id="saveMappingBtn" class="btn btn-primary">Save Mapping</button>
                    <button id="loadMappingBtn" class="btn btn-secondary">Load Mapping</button>
                    <button id="clearMappingBtn" class="btn btn-danger">Clear Mapping</button>
                </div>

                <div id="mappingList" class="mapping-list"></div>
            </div>

            <!-- Template Tab -->
            <div id="template-tab" class="tab-pane">
                <h2>Template Manager</h2>
                
                <div class="template-options">
                    <div class="form-group">
                        <label>Layout Type:</label>
                        <select id="layoutType" class="select-input">
                            <option value="flow">Flow Layout</option>
                            <option value="grid">Grid Layout</option>
                            <option value="custom">Custom Template</option>
                        </select>
                    </div>

                    <div id="gridOptions" style="display: none;">
                        <div class="form-group">
                            <label for="gridRows">Rows per Page:</label>
                            <input type="number" id="gridRows" class="text-input" value="3" min="1" max="20">
                        </div>
                        <div class="form-group">
                            <label for="gridCols">Columns per Page:</label>
                            <input type="number" id="gridCols" class="text-input" value="2" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label for="gridGutter">Gutter (mm):</label>
                            <input type="number" id="gridGutter" class="text-input" value="5" min="0" max="50">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="useMasterPage">
                            Use Master Page as Template
                        </label>
                    </div>

                    <div class="form-group">
                        <button id="createTemplateBtn" class="btn btn-primary">Create Template</button>
                        <button id="saveTemplateBtn" class="btn btn-secondary">Save Template</button>
                    </div>
                </div>

                <div id="templateList" class="template-list">
                    <h3>Saved Templates</h3>
                    <div id="templatesContainer" class="templates-container">
                        <p class="empty-message">No templates saved</p>
                    </div>
                </div>
            </div>

            <!-- Advanced Tab -->
            <div id="advanced-tab" class="tab-pane">
                <h2>Advanced Features</h2>

                <!-- Sub-tabs for Advanced features -->
                <div class="sub-tabs">
                    <button class="sub-tab-button active" data-subtab="formulas">Formulas</button>
                    <button class="sub-tab-button" data-subtab="filtering">Filtering & Sorting</button>
                    <button class="sub-tab-button" data-subtab="grouping">Grouping</button>
                    <button class="sub-tab-button" data-subtab="references">Cross-References</button>
                    <button class="sub-tab-button" data-subtab="localization">Localization</button>
                </div>

                <!-- Formulas Sub-tab -->
                <div id="formulas-subtab" class="sub-tab-pane active">
                    <h3>Formula Builder</h3>
                    
                    <div class="form-group">
                        <label for="formulaFieldName">Calculated Field Name:</label>
                        <input type="text" id="formulaFieldName" class="text-input" placeholder="e.g., price_with_tax">
                    </div>

                    <div class="form-group">
                        <label for="formulaExpression">Formula:</label>
                        <textarea id="formulaExpression" class="formula-input" rows="3" placeholder="e.g., {price} * 1.20"></textarea>
                        <small>Use {fieldName} to reference fields. Supported functions: ROUND, IF, MIN, MAX, etc.</small>
                    </div>

                    <div class="formula-helpers">
                        <div class="helper-section">
                            <h4>Available Fields</h4>
                            <div id="formulaFieldsList" class="field-list-small">
                                <p class="empty-message">Import data first</p>
                            </div>
                        </div>

                        <div class="helper-section">
                            <h4>Functions</h4>
                            <div class="function-list">
                                <button class="function-btn" data-func="ROUND(value, decimals)">ROUND</button>
                                <button class="function-btn" data-func="IF(condition, true, false)">IF</button>
                                <button class="function-btn" data-func="MIN(a, b)">MIN</button>
                                <button class="function-btn" data-func="MAX(a, b)">MAX</button>
                                <button class="function-btn" data-func="ABS(value)">ABS</button>
                                <button class="function-btn" data-func="CEIL(value)">CEIL</button>
                                <button class="function-btn" data-func="FLOOR(value)">FLOOR</button>
                            </div>
                        </div>

                        <div class="helper-section">
                            <h4>Templates</h4>
                            <select id="formulaTemplates" class="select-input">
                                <option value="">Select a template...</option>
                                <option value="{price} * (1 + {tax_rate} / 100)">Price with Tax</option>
                                <option value="{price} - ({price} * {discount} / 100)">Discount (Percent)</option>
                                <option value="IF({quantity} > 100, {price} * 0.9, {price})">Bulk Discount</option>
                                <option value="ROUND({price} * {exchange_rate}, 2)">Currency Conversion</option>
                                <option value="{price} * {quantity}">Total Price</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Preview:</label>
                        <div id="formulaPreview" class="preview-box">Enter a formula to see preview</div>
                    </div>

                    <div class="button-group">
                        <button id="testFormulaBtn" class="btn btn-secondary">Test Formula</button>
                        <button id="addFormulaBtn" class="btn btn-primary">Add Formula</button>
                        <button id="clearFormulaBtn" class="btn btn-secondary">Clear</button>
                    </div>

                    <div id="formulaList" class="item-list">
                        <h4>Saved Formulas</h4>
                        <div id="formulasContainer"></div>
                    </div>
                </div>

                <!-- Filtering Sub-tab -->
                <div id="filtering-subtab" class="sub-tab-pane">
                    <h3>Filter & Sort Data</h3>

                    <div class="filter-builder">
                        <h4>Filters</h4>
                        <div id="filtersList" class="filters-container"></div>
                        
                        <div class="add-filter-section">
                            <div class="filter-row">
                                <select id="filterField" class="select-input">
                                    <option value="">Select field...</option>
                                </select>
                                <select id="filterOperator" class="select-input">
                                    <option value="equals">Equals</option>
                                    <option value="notEquals">Not Equals</option>
                                    <option value="contains">Contains</option>
                                    <option value="startsWith">Starts With</option>
                                    <option value="endsWith">Ends With</option>
                                    <option value="greaterThan">Greater Than</option>
                                    <option value="lessThan">Less Than</option>
                                    <option value="isEmpty">Is Empty</option>
                                    <option value="isNotEmpty">Is Not Empty</option>
                                </select>
                                <input type="text" id="filterValue" class="text-input" placeholder="Value">
                                <button id="addFilterBtn" class="btn btn-primary">Add Filter</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Combine filters with:</label>
                            <select id="filterLogic" class="select-input">
                                <option value="AND">AND (all must match)</option>
                                <option value="OR">OR (any can match)</option>
                            </select>
                        </div>
                    </div>

                    <div class="sort-builder">
                        <h4>Sort By</h4>
                        <div id="sortRulesList" class="sort-container"></div>
                        
                        <div class="add-sort-section">
                            <div class="sort-row">
                                <select id="sortField" class="select-input">
                                    <option value="">Select field...</option>
                                </select>
                                <select id="sortDirection" class="select-input">
                                    <option value="asc">Ascending</option>
                                    <option value="desc">Descending</option>
                                </select>
                                <button id="addSortBtn" class="btn btn-primary">Add Sort</button>
                            </div>
                        </div>
                    </div>

                    <div class="filter-stats">
                        <p id="filterStatsText">No filters applied</p>
                    </div>

                    <div class="button-group">
                        <button id="applyFiltersBtn" class="btn btn-success">Apply Filters</button>
                        <button id="saveFilterPresetBtn" class="btn btn-secondary">Save Preset</button>
                        <button id="loadFilterPresetBtn" class="btn btn-secondary">Load Preset</button>
                        <button id="clearFiltersBtn" class="btn btn-danger">Clear All</button>
                    </div>
                </div>

                <!-- Grouping Sub-tab -->
                <div id="grouping-subtab" class="sub-tab-pane">
                    <h3>Group Data</h3>

                    <div class="form-group">
                        <label>Group By:</label>
                        <div id="groupLevelsList" class="group-levels-container"></div>
                        
                        <div class="add-group-section">
                            <select id="groupField" class="select-input">
                                <option value="">Select field...</option>
                            </select>
                            <select id="groupDirection" class="select-input">
                                <option value="asc">Ascending</option>
                                <option value="desc">Descending</option>
                            </select>
                            <button id="addGroupBtn" class="btn btn-primary">Add Level</button>
                        </div>
                    </div>

                    <div class="group-options">
                        <h4>Group Options</h4>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="showGroupHeaders" checked>
                                Show group headers
                            </label>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="showItemCount" checked>
                                Show item count in headers
                            </label>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="pageBreakPerGroup">
                                Start new page per group
                            </label>
                        </div>

                        <div class="form-group">
                            <label for="groupHeaderStyle">Header Style:</label>
                            <select id="groupHeaderStyle" class="select-input">
                                <option value="heading1">Heading 1</option>
                                <option value="heading2">Heading 2</option>
                                <option value="heading3">Heading 3</option>
                                <option value="bold">Bold Text</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="groupSeparator">Separator:</label>
                            <select id="groupSeparator" class="select-input">
                                <option value="line">Line</option>
                                <option value="space">Extra Space</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>

                    <div class="button-group">
                        <button id="applyGroupingBtn" class="btn btn-success">Apply Grouping</button>
                        <button id="clearGroupingBtn" class="btn btn-danger">Clear Grouping</button>
                    </div>
                </div>

                <!-- Cross-References Sub-tab -->
                <div id="references-subtab" class="sub-tab-pane">
                    <h3>Cross-References Manager</h3>

                    <div class="form-group">
                        <label for="refSourceId">Source Product/Record ID:</label>
                        <input type="text" id="refSourceId" class="text-input" placeholder="Enter source ID">
                    </div>

                    <div class="form-group">
                        <label for="refTargetId">Target Product/Record ID:</label>
                        <input type="text" id="refTargetId" class="text-input" placeholder="Enter target ID">
                    </div>

                    <div class="form-group">
                        <label for="refType">Reference Type:</label>
                        <select id="refType" class="select-input">
                            <option value="related">Related Product</option>
                            <option value="variant">Product Variant</option>
                            <option value="see_also">See Also</option>
                            <option value="replaced_by">Replaced By</option>
                            <option value="accessory">Accessory</option>
                            <option value="compatible">Compatible Item</option>
                            <option value="series">Product Series</option>
                        </select>
                    </div>

                    <div class="button-group">
                        <button id="addReferenceBtn" class="btn btn-primary">Add Reference</button>
                        <button id="validateReferencesBtn" class="btn btn-secondary">Validate References</button>
                        <button id="importReferencesBtn" class="btn btn-secondary">Import from Field</button>
                    </div>

                    <div id="referencesList" class="item-list">
                        <h4>Current References</h4>
                        <div id="referencesContainer"></div>
                    </div>

                    <div class="reference-options">
                        <h4>Display Options</h4>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="showRefAsList" checked>
                                Show references as list in catalog
                            </label>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="includePageNumbers">
                                Include page numbers in references
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Localization Sub-tab -->
                <div id="localization-subtab" class="sub-tab-pane">
                    <h3>Multi-Language Support</h3>

                    <div class="form-group">
                        <label for="catalogLanguage">Catalog Language:</label>
                        <select id="catalogLanguage" class="select-input">
                            <option value="en">English</option>
                            <option value="fr">Français (French)</option>
                            <option value="de">Deutsch (German)</option>
                            <option value="es">Español (Spanish)</option>
                            <option value="it">Italiano (Italian)</option>
                            <option value="pt">Português (Portuguese)</option>
                        </select>
                    </div>

                    <div class="language-selection">
                        <h4>Enabled Languages</h4>
                        <div class="form-group">
                            <label><input type="checkbox" id="lang_en" value="en" checked disabled> English (en)</label>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="lang_fr" value="fr"> Français (fr)</label>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="lang_de" value="de"> Deutsch (de)</label>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="lang_es" value="es"> Español (es)</label>
                        </div>
                    </div>

                    <div id="fieldMappingSection">
                        <h4>Field Mapping for Selected Language</h4>
                        <p class="info-text">Map data fields to language-specific columns (e.g., productName → productName_fr)</p>
                        <div id="langFieldMappings" class="mapping-list"></div>
                        <button id="autoDetectFieldsBtn" class="btn btn-secondary">Auto-Detect Language Fields</button>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="useFallback" checked>
                            Use fallback for missing translations (default to English)
                        </label>
                    </div>

                    <div id="translationStatus" class="status-panel">
                        <h4>Translation Status</h4>
                        <div id="translationStatsContainer"></div>
                    </div>

                    <div class="button-group">
                        <button id="applyLocalizationBtn" class="btn btn-success">Apply Language</button>
                        <button id="generateAllLanguagesBtn" class="btn btn-primary">Generate All Languages</button>
                    </div>
                </div>
            </div>

            <!-- Generate Tab -->
            <div id="generate-tab" class="tab-pane">
                <h2>Generate Catalog</h2>
                
                <div class="generate-summary">
                    <div class="summary-item">
                        <label>Data Records:</label>
                        <span id="genRecordCount">0</span>
                    </div>
                    <div class="summary-item">
                        <label>Mapped Fields:</label>
                        <span id="genMappedCount">0</span>
                    </div>
                    <div class="summary-item">
                        <label>Template:</label>
                        <span id="genTemplate">None</span>
                    </div>
                </div>

                <div class="generate-options">
                    <div class="form-group">
                        <label for="startPage">Start Page:</label>
                        <input type="number" id="startPage" class="text-input" value="1" min="1">
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="clearExisting" checked>
                            Clear existing content
                        </label>
                    </div>

                    <div class="form-group">
                        <label for="imageHandling">Image Handling:</label>
                        <select id="imageHandling" class="select-input">
                            <option value="fit">Fit to Frame</option>
                            <option value="fill">Fill Frame</option>
                            <option value="center">Center in Frame</option>
                        </select>
                    </div>
                </div>

                <div class="generate-actions">
                    <button id="generateBtn" class="btn btn-success btn-large">Generate Catalog</button>
                    <button id="updateBtn" class="btn btn-primary">Update Existing</button>
                </div>

                <div id="progressContainer" class="progress-container" style="display: none;">
                    <div class="progress-bar">
                        <div id="progressBar" class="progress-fill"></div>
                    </div>
                    <p id="progressText">Processing...</p>
                </div>

                <div id="generationLog" class="log-container"></div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-pane">
                <h2>Settings</h2>
                
                <div class="settings-section">
                    <h3>General Settings</h3>
                    <div class="form-group">
                        <label for="defaultImagePath">Default Image Path:</label>
                        <input type="text" id="defaultImagePath" class="text-input" placeholder="/path/to/images">
                        <button id="browseImagePathBtn" class="btn btn-secondary">Browse</button>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="validateImages" checked>
                            Validate image paths before generation
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autoSave" checked>
                            Auto-save document during generation
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Performance</h3>
                    <div class="form-group">
                        <label for="batchSize">Batch Size:</label>
                        <input type="number" id="batchSize" class="text-input" value="100" min="10" max="1000">
                        <small>Number of records to process at once</small>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Advanced</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableLogging" checked>
                            Enable detailed logging
                        </label>
                    </div>
                    <div class="form-group">
                        <button id="clearCacheBtn" class="btn btn-danger">Clear Cache</button>
                        <button id="exportLogsBtn" class="btn btn-secondary">Export Logs</button>
                    </div>
                </div>

                <div class="settings-actions">
                    <button id="saveSettingsBtn" class="btn btn-primary">Save Settings</button>
                    <button id="resetSettingsBtn" class="btn btn-secondary">Reset to Defaults</button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <span id="statusMessage" class="status-message">Ready</span>
            <span class="version">v1.0.0</span>
        </div>
    </div>

    <script type="module" src="index.js"></script>
</body>
</html>
